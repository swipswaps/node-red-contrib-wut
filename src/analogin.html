<script type="text/javascript">
	// load custom styles and scripts 
	// this has to be added to all nodes because users COULD disable all but one node and it should still be working then...
	if (!window.wut) {
		window.wut = { prepareWebioClamp: function () { } }; // dummy object to prevent multiple loading requests
		$.getScript('/wut/files/wut.js').fail(function (jqxhr, settings, exception) { console.error('Loading wut.js failed.', exception); });
		$.getScript('/wut/files/select2.min.js').fail(function (jqxhr, settings, exception) { console.error('Loading select2.min.js failed.', exception); });
		$('head').append($('<link rel="stylesheet" type="text/css" />').attr('href', '/wut/files/select2.min.css'));
		$('head').append($('<link rel="stylesheet" type="text/css" />').attr('href', '/wut/files/wut.css'));
	}
</script>

<script type="text/javascript">
	const defaultClampCount = 8;
	const portinfoType = '1';

	let labels = {}; // { webio-id-1: { slot1: label1, slot2: label2,...}, webio-id-2: {...}, ...}
	let ranges = {}; // { webio-id-1: { slot1: { min: 0, max: 10, unit: 'V' }, slot2: {...}, ...}, webio-id-2: {...}, ...}

	RED.comms.subscribe("wut/#", function (topic, msg) {
		const webioId = topic.split("/")[2];
		const type = topic.split('/')[1];
		if (webioId && type && msg) {
			if (type === 'portlabels') {
				labels[webioId] = msg[portinfoType];
			} else if (type === 'portdata') {
				ranges[webioId] = msg[portinfoType];
			} // else: other types are not relevant here
		} else {
			console.warn('Invalid RED.comms message received', topic, msg);
		}
	});

	RED.nodes.registerType('Analog IN', {
		category: 'WuT',
		color: '#009fe3',
		defaults: {
			name: { value: '' },
			webio: { value: '', type: 'Web-IO' },
			number: { value: 1, required: true, validate: RED.validators.number() }
		},
		outputs: 1,
		icon: "wutlogo.png",
		label: function () {
			return this.name || (labels[this.webio] || [])[this.number] || 'Analog IN';
		},
		labelStyle: function () {
			return this.name ? 'node_label_italic' : '';
		},
		oneditprepare: function () {
			window.wut.prepareWebioClamp(this.number, true, defaultClampCount, labels, ranges);
		}
	});
</script>

<script type="text/x-red" data-template-name="Analog IN">
	<div class="form-row">
		<label for="node-input-name"><i class="fa fa-fw fa-tag"></i> <span data-i18n="@wiesemann-theis/node-red-contrib-wut/web-io:config.label.name"></span></label>
		<input type="text" id="node-input-name" data-i18n="[placeholder]@wiesemann-theis/node-red-contrib-wut/web-io:config.label.name" />
	</div>
	<div class="form-row">
		<label for="node-input-webio"><i class="fa fa-fw fa-globe"></i> <span data-i18n="@wiesemann-theis/node-red-contrib-wut/web-io:config.label.webio"></span></label>
		<input type="text" id="node-input-webio" />
	</div>
	<div class="form-row">
		<label for="node-input-number"><i class="fa fa-fw fa-dot-circle-o"></i> <span data-i18n="@wiesemann-theis/node-red-contrib-wut/web-io:config.label.clamp"></span></label>
		<select id="node-input-number" style="width: 70%;"></select>
	</div>
	<div class="form-row hidden" id="measurement-range-wrapper">
		<label for="measurement-range"></label>
		<span data-i18n="@wiesemann-theis/node-red-contrib-wut/web-io:config.label.range"></span>
		<span id="measurement-range"></span>
	</div>
</script>