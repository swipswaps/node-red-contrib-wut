<style>
    .comserver-checkbox {
        display: inline-block;
        width: auto !important;
        vertical-align: top !important;
    }

    .comserver-flex-container {
        display: inline-flex;
        width: 70%;
    }

    .comserver-flex-container select,
    .comserver-flex-container input,
    .comserver-flex-container .select2-container {
        flex-grow: 1;
        margin-right: 5px;
    }

    .comserver-flex-container-column {
        display: inline-flex;
        width: 70%;
        flex-direction: column;
    }

    .comserver-flex-container-column>div {
        display: flex;
        align-items: center;
        margin: 6px 0px;
    }

    .comserver-flex-container-column>div>*:first-child {
        white-space: nowrap;
        margin-right: 5px;
    }

    /** select2 styles */
    .wt-select2-dropdown .wt-row {
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
    }

    .select2-container>.selection>.select2-selection {
        border-color: #ccc;
        line-height: 34px;
        height: 34px;
    }

    .select2-container>.selection>.select2-selection>.select2-selection__rendered {
        line-height: 34px;
        padding-left: 6px;
    }

    .select2-container>.selection>.select2-selection>.select2-selection__arrow {
        height: 32px;
    }

    .select2-results>.select2-results__options {
        max-height: 400px !important;
    }
</style>

<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.8/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.8/js/select2.min.js"></script>

<script type="text/javascript">
    function onKeyDown(e) {
        if (e.keyCode === 13 && $(e.target).hasClass('select2-search__field')) {
            e.stopPropagation(); // blame: for some reason, this event causes an error in Node-RED core when propagated to window...
        }
    }

    RED.nodes.registerType('Com-Server', {
        category: 'WuT',
        color: '#009fe3',
        defaults: {
            name: { value: '' },
            host: { value: '', required: true, validate: RED.validators.regex(/^[a-z0-9\-\.]+$/i) },
            port: { value: 8000, required: true, validate: RED.validators.number() },
            format: { value: 'string' },
            encoding: { value: 'utf8' },
            delimiter: { value: '' },
            sendDelimiter: { value: false },
            setuart: { value: false },
            configport: { value: 9094, validate: RED.validators.number() }, // NOTE: this parameter currently has no GUI element!
            baudrate: { value: 3, validate: RED.validators.number() },
            parity: { value: 0, validate: RED.validators.number() },
            databits: { value: 8, validate: RED.validators.number() },
            stopbits: { value: 1, validate: RED.validators.number() },
            permupdate: { value: false }, // NOTE: this parameter currently has no GUI element!
            manualConfig: { value: false },
            device: { value: null }
        },
        credentials: { password: { type: 'password' } },
        inputs: 1,
        outputs: 1,
        icon: 'wutlogo.png',
        label: function () {
            const portLabel = +this.port === 8000 ? '' : ':' + this.port; // do not display default port
            return this.name || 'Com-Server ' + (this.host || '') + portLabel;
        },
        labelStyle: function () {
            return this.name ? 'node_label_italic' : '';
        },
        oneditsave: function () {
            if ($('#node-input-manualConfig').is(':checked')) { // delete device parameter on manual configuration
                $('#node-input-device').val('');
            }
            this.device = $('#node-input-device').val(); // because empty/invalid values are not saved automatically
            $('body').off('keydown', onKeyDown);
            $('body').off('keydown', '.select2.select2-container');
        },
        oneditcancel: function () {
            $('body').off('keydown', onKeyDown);
            $('body').off('keydown', '.select2.select2-container');
        },
        oneditprepare: function () {
            $('#node-input-format').change(function () {
                if (this.value === 'string') {
                    $('#string-details-wrapper').show();
                } else {
                    $('#string-details-wrapper').hide();
                }
            });
            $('#node-input-setuart').change(function () {
                if (this.checked) {
                    $('#uart-wrapper').show();
                } else {
                    $('#uart-wrapper').hide();
                }
            });

            let isDiscovering = false;
            let isManualConfig = this.manualConfig;
            let lastDeviceId = this.device;
            let allDevices = [];
            const node = this;

            const discoverDevices = function (clearCache) {
                isDiscovering = true;
                $('#btn-discover-devices').prop('disabled', true);
                $('#btn-discover-devices > i').attr('class', 'fa fa-fw fa-spinner fa-spin');
                const url = 'wut/devices/comserver?nodeId=' + node.id + (clearCache ? '&clearCache=true' : '');
                $.getJSON(url, function (data) {
                    isDiscovering = false;
                    $('#btn-discover-devices > i').attr('class', 'fa fa-fw fa-search');
                    $('#btn-discover-devices').prop('disabled', isManualConfig || isDiscovering);
                    if (data) {
                        allDevices = data;
                        $('#node-input-device').children('option').remove(); // remove all clamp options

                        for (let i = 0; i < data.length; ++i) {
                            const device = data[i];
                            device.text = device.ip + ' (' + device.mac + ')';
                            $('#node-input-device').append($('<option></option>').attr('value', device.id).text(device.text).attr('data-data', JSON.stringify(device)));
                        }

                        if (!lastDeviceId) {
                            const matches = allDevices.filter(function (d) { return d.ip === node.host; });
                            lastDeviceId = (matches[0] || {}).id;
                        }
                        $('#node-input-device').val(lastDeviceId).trigger('change'); // finally, restore selection
                    }
                });
            };

            $('#node-input-device').change(function () {
                const selectedId = $(this).val();
                lastDeviceId = selectedId || lastDeviceId;
                const device = allDevices.filter(function (d) { return d.id === selectedId; })[0];
                if (device) { // set host, protocol and port values
                    $('#node-input-host').val(device.ip || '').trigger('change');
                }
                if (device && !isManualConfig) { // set product details
                    $('#comserver-details-wrapper').removeClass('hidden');
                    const productId = device.productId || '';
                    $('#comserver-details-productid').text(productId).attr('href', 'https://www.wut.de/' + productId);
                    $('#comserver-details-prodname').text(sanitize(device.prodname));
                    $('#comserver-details-sysname').text(sanitize(device.sysname));
                } else {
                    $('#comserver-details-wrapper').addClass('hidden');
                }
            });

            $('#node-input-manualConfig').change(function () {
                isManualConfig = this.checked;
                $('.manual-input').prop('disabled', !isManualConfig);
                $('#node-input-device').prop('disabled', isManualConfig);
                $('#btn-discover-devices').prop('disabled', isManualConfig || isDiscovering);
                if (!isManualConfig) {
                    $('#node-input-device').trigger('change');
                } else {
                    $('#comserver-details-wrapper').addClass('hidden');
                }
            });

            $('#btn-discover-devices').click(function (e) {
                e.preventDefault();
                discoverDevices(true); // re-discover devices (clear cache!)
            });

            $('#btn-webconfig').click(function (e) {
                e.preventDefault();
                const host = $('#node-input-host').val();
                if (host) {
                    window.open('http://' + host, '_blank');
                }
            });

            function sanitize(htmlText) {
                return $('<div>' + (htmlText || '').replace(/<br[ \/]*>/g, ' ') + '</div>').text();
            }

            if ($(window).select2) {
                $('body').on('keydown', onKeyDown);
                $('body').on('keydown', '.select2.select2-container', function (e) {
                    const KEYS = { UP: 38, DOWN: 40 };
                    if (e.keyCode === KEYS.UP || (e.keyCode === KEYS.DOWN && !e.altKey)) {
                        e.preventDefault();
                        const select = $(this).siblings("select.wt-select2");
                        if (select && select.length) {
                            let newValue;
                            if (e.keyCode === KEYS.UP) {
                                newValue = select.find('option:selected').prevAll(":enabled").first().val();
                            } else {
                                newValue = select.find('option:selected').nextAll(":enabled").first().val();
                            }

                            if (newValue) {
                                select.val(newValue).trigger('change');
                            }
                        }
                    }
                });
                setTimeout(function () {
                    $('select.wt-select2:not(#node-input-device)').select2();
                    $('#node-input-device').select2({
                        templateResult: function (device) {
                            let template = '<div class="wt-select2-dropdown"><div class="wt-row">' + device.text + '</div>'
                            let title = device.text;
                            if (device.prodname) {
                                if (device.productId) {
                                    template += '<div style="display: flex;"><small class="wt-row">' + sanitize(device.prodname) + '</small><small>&nbsp;(#' + device.productId + ')</small></div>';
                                    title += '\n' + sanitize(device.prodname) + ' (#' + device.productId + ')';
                                } else {
                                    template += '<div class="wt-row"><small>' + sanitize(device.prodname) + '</small></div>';
                                    title += '\n' + sanitize(device.prodname);
                                }
                            } else if (device.productId) {
                                template += '<div class="wt-row"><small>' + node._('config.label.productid') + ' #' + device.productId + '</small></div>';
                                title += '\n' + node._('config.label.productid') + ' #' + device.productId;
                            }
                            if (device.sysname) {
                                template += '<div class="wt-row"><small>' + sanitize(device.sysname) + '</small></div>';
                                title += '\n' + sanitize(device.sysname);
                            }
                            template += '</div>';
                            return $(template).attr('title', title);
                        },
                        matcher: function (params, data) {
                            const searchBase = [data.text, data.prodname, data.sysname, data.productId].filter(Boolean).join('   ').toLowerCase();
                            const searchString = $.trim(params.term).toLowerCase();
                            return searchBase.indexOf(searchString) > -1 ? data : null;
                        }
                    });
                }, 500);
            } else {
                console.warn('select2 is not available');
            }

            discoverDevices(false); // initially discover devices (cached data is ok)
        }
    });
</script>

<script type="text/x-red" data-template-name="Com-Server">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-fw fa-tag"></i> <span data-i18n="config.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]config.label.name" />
    </div>

	<div class="form-row">
		<label for="node-input-device"><i class="fa fa-fw fa-globe"></i> <span data-i18n="config.label.device"></label>
		<div class="comserver-flex-container">
			<select class="wt-select2" id="node-input-device"></select>
			<button id="btn-discover-devices" class="editor-button" data-i18n="[title]config.label.tooltip-discover">
				<i class="fa fa-fw fa-search"></i>
			</button>
		</div>
	</div>
    <div class="form-row">
		<label>&nbsp;</label>
		<label for="node-input-manualConfig" style="width: 70%;">
			<input type="checkbox" id="node-input-manualConfig" class="comserver-checkbox" />
			<span data-i18n="config.label.manual-config">
		</label>
	</div>
	<div class="form-row">
		<label>&nbsp;</label>	
		<div class="comserver-flex-container">
			<input type="text" id="node-input-host" class="manual-input" data-i18n="[placeholder]config.label.host" />
			<button id="btn-webconfig" class="editor-button" data-i18n="[title]config.label.tooltip-webconfig">
				<i class="fa fa-fw fa-external-link"></i>
			</button>
		</div>
	</div>
	<div class="form-row">
		<label for="node-input-port"><i class="fa fa-fw fa-dot-circle-o"></i> <span data-i18n="config.label.port"></label>
		<input type="text" id="node-input-port" data-i18n="[placeholder]config.label.port" />
    </div>
    
    <div class="form-row">
        <label for=""node-input-format"><i class="fa fa-fw fa-sign-out"></i> <span data-i18n="config.label.format"></span></label>
        <select class="wt-select2" id="node-input-format" style="width: 70%;">
            <option value="string" data-i18n="config.format.string"></option>
            <option value="buffer" data-i18n="config.format.buffer"></option>
        </select>
    </div>

    <div id="string-details-wrapper">
        <div class="form-row">
            <label>&nbsp;</label>
            <label for="node-input-delimiter" style="width: 70%; display: inline-flex; align-items: center;">
                <span data-i18n="config.label.delimiter" style="margin-right: 5px;"></span>
                <input type="text" id="node-input-delimiter" style="flex-grow: 1;" />
            </label>
        </div>

        <div class="form-row">
            <label>&nbsp;</label>
            <label for="node-input-sendDelimiter" style="width: 70%;">
                <input type="checkbox" id="node-input-sendDelimiter" class="comserver-checkbox" />
                <span data-i18n="config.label.send-delimiter">
            </label>
        </div>
    </div>

    <div class="form-row">
        <label for="node-input-encoding"><i class="fa fa-fw fa-exchange"></i> <span data-i18n="config.label.encoding"></span></label>
        <select class="wt-select2" id="node-input-encoding" style="width: 70%;">
            <option>utf8</option>
            <option>latin1</option>
        </select>
    </div>
    
    <div class="form-row">
		<label>&nbsp;</label>
		<label for="node-input-setuart" style="width: 70%;">
			<input type="checkbox" id="node-input-setuart" class="comserver-checkbox" />
			<span data-i18n="config.label.setuart">
		</label>
	</div>
    
    <div id="uart-wrapper">
        <div class="form-row hidden">
            <!-- Hidden (for now). Maybe to be enabled in future releases... -->
            <label for="node-input-configport"><i class="fa fa-fw fa-gear"></i> <span data-i18n="config.label.configport"></label>
            <input type="text" id="node-input-configport" />
        </div>

        <div class="form-row">
            <label for="node-input-baudrate"><i class="fa fa-fw fa-gear"></i> <span data-i18n="config.label.baudrate"></label>
            <select class="wt-select2" id="node-input-baudrate" style="width: 70%;">
                <option value="11">230,4k</option>
                <option value="14">153,6k</option>
                <option value="15">115,2k</option>
                <option value="0">57.600</option>
                <option value="1">38.400</option>
                <option value="2">19.200</option>
                <option value="3">9.600</option>
                <option value="5">4.800</option>
                <option value="6">2.400</option>
                <option value="7">1.200</option>
                <option value="8">600</option>
                <option value="9">300</option>
                <option value="10">150</option>
                <option value="16">110</option>
                <option value="12">75</option>
                <option value="13">50</option>
            </select>
        </div>
        
        <div class="form-row">
            <label for="node-input-parity"><i class="fa fa-fw fa-gear"></i> <span data-i18n="config.label.parity"></label>
            <select class="wt-select2" id="node-input-parity" style="width: 70%;">
                <option value="0">NONE</option>
                <option value="3">EVEN</option>
                <option value="1">ODD</option>
                <option value="7">SPACE</option>
                <option value="5">MARK</option>
            </select>
        </div>
        
        <div class="form-row">
            <label for="node-input-databits"><i class="fa fa-fw fa-gear"></i> <span data-i18n="config.label.databits"></label>
            <select class="wt-select2" id="node-input-databits" style="width: 70%;">
                <option>5</option>
                <option>6</option>
                <option>7</option>
                <option>8</option>
            </select>
        </div>
        
        <div class="form-row">
            <label for="node-input-stopbits"><i class="fa fa-fw fa-gear"></i> <span data-i18n="config.label.stopbits"></label>
            <select class="wt-select2" id="node-input-stopbits" style="width: 70%;">
                <option>1</option>
                <option>2</option>
            </select>
        </div>

        <div class="form-row">
            <label for="node-input-password"><i class="fa fa-fw fa-gear"></i> <span data-i18n="config.label.password"></label>
            <input type="password" id="node-input-password" />
        </div>
        
        <div class="form-row hidden">
            <!-- Hidden (for now). Maybe to be enabled in future releases... -->
            <label>&nbsp;</label>
            <label for="node-input-permupdate" style="width: 70%;">
                <input type="checkbox" id="node-input-permupdate" class="comserver-checkbox" />
                <span data-i18n="config.label.permupdate">
            </label>
        </div>
    </div>
	<div id="comserver-details-wrapper">
        <hr/>
		<div class="form-row">
			<label for="comserver-details-productid"></label>
			<div class="comserver-flex-container-column">
				<div>
					<span data-i18n="config.label.productid"></span>
					<a href="https://www.wut.de/" target="_blank" id="comserver-details-productid"></a>
				</div>
				<div>
					<span data-i18n="config.label.prodname"></span>
					<span id="comserver-details-prodname"></span>
				</div>
				<div>
					<span data-i18n="config.label.sysname"></span>
					<span id="comserver-details-sysname"></span>
				</div>
			</div>
		</div>
	</div>
</script>