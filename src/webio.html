<style>
	.webio-flex-container {
		display: inline-flex;
		width: 70%;
	}

	.webio-flex-container select,
	.webio-flex-container input,
	.webio-flex-container .select2-container {
		flex-grow: 1;
		margin-right: 5px;
	}

	.webio-flex-container-column {
		display: inline-flex;
		width: 70%;
		flex-direction: column;
	}

	.webio-flex-container-column>div {
		display: flex;
		align-items: center;
		margin: 6px 0px;
	}

	.webio-flex-container-column>div>*:first-child {
		white-space: nowrap;
		margin-right: 5px;
	}

	.webio-checkbox {
		display: inline-block;
		width: auto !important;
		vertical-align: top !important;
	}

	/** select2 styles */
	.wt-select2-dropdown .wt-row {
		overflow: hidden;
		white-space: nowrap;
		text-overflow: ellipsis;
	}

	.select2-container>.selection>.select2-selection {
		border-color: #ccc;
		line-height: 34px;
		height: 34px;
	}

	.select2-container>.selection>.select2-selection>.select2-selection__rendered {
		line-height: 34px;
		padding-left: 6px;
	}

	.select2-container>.selection>.select2-selection>.select2-selection__arrow {
		height: 32px;
	}

	.select2-results>.select2-results__options {
		max-height: 400px !important;
	}
</style>

<script type="text/javascript">
	// handle webio-i18n-status messages here (handling it in analogin, analogout,... would be redundant -> and there are no webio-i18n-status messages if there is no webio!)
	const startTime = new Date();
	const startupTimer = setInterval(function () {
		const nodes = RED.nodes.filterNodes({}) || [];
		if (nodes.length || new Date() - startTime > 10000) {
			clearInterval(startupTimer);
			RED.comms.subscribe("wut/webio-i18n-status/#", function (topic, msg) {
				if (msg && msg.text) {
					const id = topic.split("/")[2];
					const node = RED.nodes.node(id);
					if (node) {
						const key = msg.text.indexOf('@wiesemann-theis') === 0 ? msg.text : '@wiesemann-theis/node-red-contrib-wut/web-io:' + msg.text;
						msg.text = node._(key, msg.params || {});
						node.status = msg;
						node.dirty = true;
						RED.view.redraw();
					} else {
						console.warn('Invalid webio-i18n-status message received. Cannot find node with id ' + id);
					}
				} else {
					console.warn('Invalid webio-i18n-status message received. Message is empty or invalid:', msg);
				}
			});
		}
	}, 300); // subscribe only when nodes have been loaded (or 10s timeout) -> otherwise retained messages might not be processed correctly because node is not available yet

	function onKeyDown(e) {
        if (e.keyCode === 13 && $(e.target).hasClass('select2-search__field')) {
            e.stopPropagation(); // blame: for some reason, this event causes an error in Node-RED core when propagated to window...
        }
    }

    RED.nodes.registerType('Web-IO', {
		category: 'config',
		defaults: {
			name: { value: '' },
			protocol: { value: 'http' },
			host: { value: '', required: true, validate: RED.validators.regex(/^[a-z0-9\-\.]+$/i) },
			port: { value: 80, required: true, validate: RED.validators.number() },
			pollingIntervalSec: { value: 1, validate: RED.validators.number() }, // no corresponding input element (yet)
			portinfoIntervalSec: { value: 60, validate: RED.validators.number() }, // no corresponding input element (yet)
			manualConfig: { value: false },
			device: { value: null }
		},
		credentials: { password: { type: 'password' } },
		label: function () {
			return this.name || this.host + ":" + this.port;
		},
		oneditsave: function () {
			if ($('#node-config-input-manualConfig').is(':checked')) { // delete device parameter on manual configuration
				$('#node-config-input-device').val('');
			}
			this.device = $('#node-config-input-device').val(); // because empty/invalid values are not saved automatically
			$('body').off('keydown', onKeyDown);
			$('body').off('keydown', '.select2.select2-container');
		},
		oneditcancel: function () {
			$('body').off('keydown', onKeyDown);
			$('body').off('keydown', '.select2.select2-container');
		},
		oneditprepare: function () {
			let isDiscovering = false;
			let isManualConfig = this.manualConfig;
			let lastDeviceId = this.device;
			let allDevices = [];
			const node = this;

			const discoverDevices = function (clearCache) {
				isDiscovering = true;
				$('#btn-discover-devices').prop('disabled', true);
				$('#btn-discover-devices > i').attr('class', 'fa fa-fw fa-spinner fa-spin');
				const url = 'wut/devices/webio?nodeId=' + node.id + (clearCache ? '&clearCache=true' : '');
				$.getJSON(url, function (data) {
					isDiscovering = false;
					$('#btn-discover-devices > i').attr('class', 'fa fa-fw fa-search');
					$('#btn-discover-devices').prop('disabled', isManualConfig || isDiscovering);
					if (data) {
						allDevices = data;
						$('#node-config-input-device').children('option').remove(); // remove all clamp options

						for (let i = 0; i < data.length; ++i) {
							const device = data[i];
							device.text = device.ip + ':' + device.port + ' (' + device.mac + ')';
							$('#node-config-input-device').append($('<option></option>').attr('value', device.id).text(device.text).attr('data-data', JSON.stringify(device)));
						}

						if (!lastDeviceId) {
							const matches = allDevices.filter(function (d) { return d.ip === node.host && +d.port === +node.port && node.protocol === (d.httpsEnabled ? 'https' : 'http'); });
							lastDeviceId = (matches[0] || {}).id;
						}
						$('#node-config-input-device').val(lastDeviceId).trigger('change'); // finally, restore selection
					}
				});
			};

			$('#node-config-input-device').change(function () {
				const selectedId = $(this).val();
				lastDeviceId = selectedId || lastDeviceId;
				const device = allDevices.filter(function (d) { return d.id === selectedId; })[0];
				if (device) { // set host, protocol and port values
					$('#node-config-input-host').val(device.ip || '').trigger('change');
					$('#node-config-input-protocol').val(device.httpsEnabled ? 'https' : 'http').trigger('change');
					$('#node-config-input-port').val(device.port || '').trigger('change');
				}
				if (device && !isManualConfig) { // set product details
					$('#webio-details-wrapper').removeClass('hidden');
					const productId = device.productId || '';
					$('#webio-details-productid').html(productId).attr('href', 'https://www.wut.de/' + productId);
					$('#webio-details-prodname').html(device.prodname || '');
					$('#webio-details-sysname').html(device.sysname || '');
				} else {
					$('#webio-details-wrapper').addClass('hidden');
				}
			});

			$('#node-config-input-manualConfig').change(function () {
				isManualConfig = this.checked;
				$('.manual-config-input').prop('disabled', !isManualConfig);
				$('#node-config-input-device').prop('disabled', isManualConfig);
				$('#btn-discover-devices').prop('disabled', isManualConfig || isDiscovering);
				if (!isManualConfig) {
					$('#node-config-input-device').trigger('change');
				} else {
					$('#webio-details-wrapper').addClass('hidden');
				}
			});

			$('#btn-discover-devices').click(function (e) {
				e.preventDefault();
				discoverDevices(true); // re-discover devices (clear cache!)
			});

			$('#btn-webconfig').click(function (e) {
				e.preventDefault();
				const protocol = $('#node-config-input-protocol').val();
				const host = $('#node-config-input-host').val();
				const port = $('#node-config-input-port').val();
				if (protocol && host && port) {
					window.open(protocol + '://' + host + ':' + port, '_blank');
				}
			});

			function sanitize(htmlText) {
				return $('<div>' + htmlText + '</div>').text();
			}

			if ($(window).select2) {
				$('body').on('keydown', onKeyDown);
				$('body').on('keydown', '.select2.select2-container', function (e) {
					const KEYS = { UP: 38, DOWN: 40 };
					if (e.keyCode === KEYS.UP || (e.keyCode === KEYS.DOWN && !e.altKey)) {
						e.preventDefault();
						const select = $(this).siblings("select.wt-select2");
						if (select && select.length) {
							let newValue;
							if (e.keyCode === KEYS.UP) {
								newValue = select.find('option:selected').prevAll(":enabled").first().val();
							} else {
								newValue = select.find('option:selected').nextAll(":enabled").first().val();
							}

							if (newValue) {
								select.val(newValue).trigger('change');
							}
						}
					}
				});
				setTimeout(function () {
					$('select.wt-select2:not(#node-config-input-device)').select2();
					$('#node-config-input-device').select2({
						templateResult: function (device) {
							let template = '<div class="wt-select2-dropdown"><div class="wt-row">' + device.text + '</div>'
							let title = device.text;
							if (device.prodname) {
								if (device.productId) {
									template += '<div style="display: flex;"><small class="wt-row">' + sanitize(device.prodname) + '</small><small>&nbsp;(#' + device.productId + ')</small></div>';
									title += '\n' + sanitize(device.prodname) + ' (#' + device.productId + ')';
								} else {
									template += '<div class="wt-row"><small>' + sanitize(device.prodname) + '</small></div>';
									title += '\n' + sanitize(device.prodname);
								}
							} else if (device.productId) {
								template += '<div class="wt-row"><small>' + node._('config.label.productid') + ' #' + device.productId + '</small></div>';
								title += '\n' + node._('config.label.productid') + ' #' + device.productId;
							}
							if (device.sysname) {
								template += '<div class="wt-row"><small>' + node._('config.label.sysname') + ' ' + sanitize(device.sysname) + '</small></div>';
								title += '\n' + node._('config.label.sysname') + ' ' + sanitize(device.sysname);
							}
							template += '</div>';
							return $(template).attr('title', title);
						},
						matcher: function (params, data) {
							const searchBase = [data.text, data.prodname, data.sysname, data.productId].filter(Boolean).join('   ').toLowerCase();
							const searchString = $.trim(params.term).toLowerCase();
							return searchBase.indexOf(searchString) > -1 ? data : null;
						}
					});
				}, 500);
			} else {
				console.warn('select2 is not available');
			}

			discoverDevices(false); // initially discover devices (cached data is ok)
		}
	});
</script>

<script type="text/x-red" data-template-name="Web-IO">
	<div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-fw fa-tag"></i> <span data-i18n="config.label.name"></span></label>
		<input type="text" id="node-config-input-name" data-i18n="[placeholder]config.label.name" />
	</div>
	<div class="form-row">
		<label for="node-config-input-device"><i class="fa fa-fw fa-globe"></i> <span data-i18n="config.label.device"></label>
		<div class="webio-flex-container">
			<select class="wt-select2" id="node-config-input-device"></select>
			<button id="btn-discover-devices" class="editor-button" data-i18n="[title]config.label.tooltip-discover">
				<i class="fa fa-fw fa-search"></i>
			</button>
		</div>
	</div>
    <div class="form-row">
		<label>&nbsp;</label>
		<label for="node-config-input-manualConfig" style="width: 70%;">
			<input type="checkbox" id="node-config-input-manualConfig" class="webio-checkbox" />
			<span data-i18n="config.label.manual-config">
		</label>
	</div>
	<div class="form-row">
		<label for="node-config-input-host"><i class="fa fa-fw fa-globe"></i> <span data-i18n="config.label.host"></label>		
		<div class="webio-flex-container">
			<input type="text" id="node-config-input-host" class="manual-config-input" data-i18n="[placeholder]config.label.host" />
			<button id="btn-webconfig" class="editor-button" data-i18n="[title]config.label.tooltip-webconfig">
				<i class="fa fa-fw fa-external-link"></i>
			</button>
		</div>
	</div>
	<div class="form-row">
		<label for="node-config-input-protocol"><i class="fa fa-fw fa-globe"></i> <span data-i18n="config.label.protocol"></label>
		<select id="node-config-input-protocol" class="manual-config-input wt-select2" style="width: 70%;">
			<option value="http">HTTP</option>
			<option value="https">HTTPS</option>
		</select>
	</div>
	<div class="form-row">
		<label for="node-config-input-port"><i class="fa fa-fw fa-dot-circle-o"></i> <span data-i18n="config.label.port"></label>
		<input type="text" id="node-config-input-port" class="manual-config-input" data-i18n="[placeholder]config.label.port" />
	</div>
	<div class="form-row">
		<label for="node-config-input-password"><i class="fa fa-fw fa-unlock-alt"></i> <span data-i18n="config.label.password"></label>
		<input type="password" id="node-config-input-password" data-i18n="[placeholder]config.label.password" />
	</div>
	<div id="webio-details-wrapper">
		<hr/>
		<div class="form-row">
			<label for="webio-details-productid"></label>
			<div class="webio-flex-container-column">
				<div>
					<span data-i18n="config.label.productid"></span>
					<a href="https://www.wut.de/" target="_blank" id="webio-details-productid"></a>
				</div>
				<div>
					<span data-i18n="config.label.prodname"></span>
					<span id="webio-details-prodname"></span>
				</div>
				<div>
					<span data-i18n="config.label.sysname"></span>
					<span id="webio-details-sysname"></span>
				</div>
			</div>
		</div>
	</div>
</script>